FROM golang:1.23-alpine AS builder

RUN apk add --no-cache git

WORKDIR /build
COPY harness/go.mod harness/go.sum* ./
RUN go mod download 2>/dev/null || true

COPY harness/ ./
RUN CGO_ENABLED=0 go build -o /harness ./cmd/harness

FROM alpine:3.20

RUN apk add --no-cache \
    docker-cli \
    git \
    tmux \
    curl \
    jq \
    openssh

COPY --from=builder /harness /usr/local/bin/harness

EXPOSE 8090 2222

ENTRYPOINT ["harness"]
