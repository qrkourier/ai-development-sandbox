#!/bin/bash
set -euo pipefail

# Resolve the directory where this script lives (works from any cwd)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
    cat <<'EOF'
Usage: dev [OPTIONS] [COMMAND] [ARGS...]

Run from your project directory — cwd becomes the workspace inside the container.

Commands:
  claude [args...]     Launch Claude Code (permissive mode)
  opencode [args...]   Launch OpenCode
  bash                 Interactive shell (default)
  build                Build/rebuild the sandbox image

Options:
  -w, --workspace DIR       Override workspace directory (default: cwd)
  -c, --context DIR[:PATH]  Mount additional context directory (repeatable)
                             DIR = host path, PATH = container path
                             Default PATH: /workspace/context/<basename>
  -h, --help                Show help

Examples:
  cd ~/projects/myapp && dev claude          # work on myapp
  dev -c ~/shared-libs claude                # with extra context
  dev -w ~/other-project opencode            # explicit workspace override
EOF
}

# ---------------------------------------------------------------------------
# Preflight: ensure host paths exist so Docker doesn't create them as
# root-owned directories. This is the main ergonomic win — run ./dev and
# everything Just Works even on a fresh machine.
# ---------------------------------------------------------------------------
preflight() {
    # Directories that must exist (Docker bind-mounts create them as root if missing)
    mkdir -p "$HOME/.ssh"
    mkdir -p "$HOME/.claude"
    mkdir -p "$HOME/.local/share/opencode"

    # Files that are bind-mounted directly — if missing, Docker creates a
    # *directory* at that path, which breaks everything downstream.
    # Touch them as empty files so the mount works; the entrypoint and tools
    # handle the "empty/missing credentials" case gracefully.
    [[ -f "$HOME/.gitconfig" ]] || touch "$HOME/.gitconfig"

    # Check for docker compose
    if ! command -v docker &>/dev/null; then
        echo "Error: docker is not installed or not in PATH" >&2
        exit 1
    fi
    if ! docker compose version &>/dev/null; then
        echo "Error: 'docker compose' plugin not available" >&2
        exit 1
    fi
}

# ---------------------------------------------------------------------------
# Ensure the sandbox image exists, building it if necessary
# ---------------------------------------------------------------------------
ensure_image() {
    if ! docker image inspect ai-dev-sandbox:latest &>/dev/null; then
        echo "Image ai-dev-sandbox:latest not found — building..." >&2
        docker compose -f "$SCRIPT_DIR/compose.yaml" build
    fi
}

# ---------------------------------------------------------------------------
# Parse arguments
# ---------------------------------------------------------------------------
WORKSPACE=""
CONTEXT_VOLUMES=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -w|--workspace)
            WORKSPACE="$(cd "$2" && pwd)"
            shift 2
            ;;
        -c|--context)
            spec="$2"
            if [[ "$spec" == *:* ]]; then
                host_dir="${spec%%:*}"
                container_path="${spec#*:}"
            else
                host_dir="$spec"
                container_path="/workspace/context/$(basename "$host_dir")"
            fi
            host_dir="$(cd "$host_dir" && pwd)"
            CONTEXT_VOLUMES+=("-v" "${host_dir}:${container_path}:ro")
            shift 2
            ;;
        -*)
            echo "Unknown option: $1" >&2
            usage >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

COMMAND="${1:-bash}"

# Handle build command separately (no preflight needed beyond docker check)
if [[ "$COMMAND" == "build" ]]; then
    preflight
    exec docker compose -f "$SCRIPT_DIR/compose.yaml" build
fi

# Shift past the command name so remaining args are forwarded
if [[ $# -gt 0 ]]; then
    shift
fi

# ---------------------------------------------------------------------------
# Preflight and image check
# ---------------------------------------------------------------------------
preflight
ensure_image

# Export SANDBOX_WORKSPACE for compose variable interpolation.
# Default to cwd so the caller's project is mounted — not the compose file's
# directory (Docker Compose resolves relative paths relative to the compose file).
export SANDBOX_WORKSPACE="${WORKSPACE:-$PWD}"

# ---------------------------------------------------------------------------
# Build compose file list, skipping mounts for missing credential files.
# Docker bind-mounts create empty *directories* when the source file doesn't
# exist — the credential staging paths expect files, not dirs, so we must
# omit these mounts entirely when the host file is absent.
# ---------------------------------------------------------------------------
CLAUDE_CREDS="$HOME/.claude/.credentials.json"
OPENCODE_AUTH="$HOME/.local/share/opencode/auth.json"

SKIP_CLAUDE_CREDS=false
SKIP_OPENCODE_AUTH=false

[[ -f "$CLAUDE_CREDS" ]]  || { SKIP_CLAUDE_CREDS=true;  echo "Note: $CLAUDE_CREDS not found — skipping mount" >&2; }
[[ -f "$OPENCODE_AUTH" ]]  || { SKIP_OPENCODE_AUTH=true;  echo "Note: $OPENCODE_AUTH not found — skipping mount" >&2; }

if [[ "$SKIP_CLAUDE_CREDS" == true ]] || [[ "$SKIP_OPENCODE_AUTH" == true ]]; then
    # Create a temporary compose override that replaces the volumes list,
    # including only the mounts whose source files actually exist.
    OVERRIDE_FILE=$(mktemp /tmp/compose-override-XXXXXX.yaml)
    trap "rm -f '$OVERRIDE_FILE'" EXIT

    cat > "$OVERRIDE_FILE" <<YAML
services:
  dev-sandbox:
    volumes:
      - \${SANDBOX_WORKSPACE:-.}:/workspace/project:rw
      - ${SCRIPT_DIR}:/workspace/sandbox:rw
      - ~/.gitconfig:/home/dev/.gitconfig:ro
      - ~/.ssh:/home/dev/.ssh:ro
YAML

    if [[ "$SKIP_CLAUDE_CREDS" == false ]]; then
        cat >> "$OVERRIDE_FILE" <<YAML
      - ~/.claude/.credentials.json:/home/dev/.claude-credentials/.credentials.json:ro
YAML
    fi
    if [[ "$SKIP_OPENCODE_AUTH" == false ]]; then
        cat >> "$OVERRIDE_FILE" <<YAML
      - ~/.local/share/opencode/auth.json:/home/dev/.local/share/opencode/auth.json:ro
YAML
    fi

    COMPOSE_FILES=(-f "$SCRIPT_DIR/compose.yaml" -f "$OVERRIDE_FILE")
else
    COMPOSE_FILES=(-f "$SCRIPT_DIR/compose.yaml")
fi

exec docker compose "${COMPOSE_FILES[@]}" run --rm \
    "${CONTEXT_VOLUMES[@]+"${CONTEXT_VOLUMES[@]}"}" \
    dev-sandbox "$COMMAND" "$@"
